library(data.table)
##library(playbase)
library(ggplot2)
library(igraph)
library(devtools)
load_all("~/Playground/playbase")
load_all("~/Projects/WGCNAplus")
load_all("..")

## Imports
gset.rankcor <- playbase::gset.rankcor
mat2gmt <- playbase::mat2gmt
ai.ask <- playbase::ai.ask
ai.create_image_gemini <- playbase::ai.create_image_gemini
lasagna.multisolve <- playbase::lasagna.multisolve

data <- playbase::mofa.exampledata("geiger")
data <- playbase::mofa.exampledata("brca")
data <- playbase::mofa.exampledata("cll")

ntop=1000;nc=20;add.sink=TRUE;intra=TRUE;use.gmt=FALSE;use.graphite=0;
fully_connect=FALSE;add.revpheno=TRUE;condition.edges=1

names(data)
names(data$X)
data$X <- data$X[c("mx","px")]

obj <- lasagna::create_model(data, pheno="pheno", ntop=1000, nc=10,
  add.sink=TRUE, intra=FALSE, fully_connect=FALSE, add.revpheno=TRUE,
  condition.edges=1)
names(obj)

## color by WGCNA clustering
if(0) {
  wgcna <- WGCNAplus::computeWGCNA_multiomics(data$X, data$samples)
  names(wgcna)
  head(wgcna$me.colors)
  V(obj$graph)$color <- substring(wgcna$me.colors[V(obj$graph)$name],3,99)
  V(obj$graph)$color[is.na(V(obj$graph)$color)] <- "red"
}

## solve the graph for a certain phenotype
colnames(obj$Y)
pheno = "activated=act"
graph <- lasagna::solve(obj, pheno, min_rho=0.01, max_edges=1000,
  value="rho", sp.weight=1, prune=FALSE) 
graph

## annotate metabolites with title
probes <- V(graph)$name
ax <- playbase:::getMultiOmicsProbeAnnotation("Human",probes)
head(ax)
ax <- ax[match(V(graph)$name, ax$feature),]
ii <- grep("mx",V(graph)$name)
V(graph)$label <- V(graph)$name
V(graph)$label[ii] <- paste0("mx:{",ax$gene_title,"}")[ii]

## prune graph for cleaner plotting
par(mfrow=c(1,1), mar=c(1,1,1,1)*0)
mp <- lasagna::plot_multipartite(graph)

mp <- lasagna::plot_multipartite(
  graph,
  min.rho = 0.8,
  ntop = 40,
  xdist = 1,
  color.var = "color",
  labpos = c(2,2,4,4),
  cex.label = 0.8,
  vx.cex = 1.1,
  edge.cex = 0.8,
  edge.alpha = 0.2,
  edge.sign = "both",
  edge.type = "inter",  
  yheight = 0.99,
  normalize.edges = 1,
  strip.prefix = TRUE,
  prune = 0
) 
names(mp)
mp$graph

## interactive multipartite
M <- mp$layout
vis <- lasagna::plot_visgraph(mp$graph, layers=NULL, ntop=-1,
  min_rho=0.4, ecex=0.3, vcex=2, labcex=1, egamma=1,
  color.var="color", mst=FALSE, layout=M, physics=0) 
vis

## MST - FR layout
require(visNetwork)
mst <- mst(mp$graph)
vis <- lasagna::plot_visgraph(mst, layers=NULL, ntop=-1,
  min_rho=0.5, ecex=1, egamma=5, vcex=1, mst=FALSE,
  color.var="color", physics=0) 
vis

## hierarchical layout
vis %>% visHierarchicalLayout()

##-------------------------------------------------
## 3D lasagna
##-------------------------------------------------
##source("~/Playground/playbase/dev/include.R", chdir=TRUE)
load_all("..")

xpos <- layout_multipartite_3d(graph, obj$X, clust='svd')
xpos <- layout_multipartite_3d(graph, obj$X, clust='tsne')
xpos <- layout_multipartite_3d(graph, obj$X, clust='umap')

plot_3d(graph, layout=xpos, draw_edges=TRUE,
  color.by = "color", min_rho=0.0, sign_rho="pos",
  cex=1, num_edges=1000, znames=NULL) 

  
##-------------------------------------------------
##-------------------------------------------------
##-------------------------------------------------
